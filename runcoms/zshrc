# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Debug toggle
export ZSH_DEBUG=false

# Enable zsh debugging if toggle is on
if [[ "${ZSH_DEBUG}" == "true" ]]; then
    setopt XTRACE
    setopt VERBOSE
    PS4='+%N:%i> '
    zmodload zsh/zprof
fi

# Helper function to safely add paths
function add_to_path() {
    local dir="${1}"
    if [[ -d "${dir}" && ":${PATH}:" != *":${dir}:"* ]]; then
        export PATH="${dir}:${PATH}"
    fi
}

# Helper function to safely source files
function source_if_exists() {
    local file="${1}"
    local source_file="${0}"

    # Skip if file doesn't exist
    if [[ ! -s "${file}" ]]; then
        [[ "${ZSH_DEBUG}" == "true" ]] && echo "[$(date '+%Y-%m-%d %H:%M:%S')] [${source_file}] File does not exist or is empty: ${file}"
    else
        source "${file}"
    fi
}

# Add directories to PATH
add_to_path "${HOME}/code/bin/commands"
add_to_path "${HOME}/code/bin/tools"
add_to_path "${HOME}/code/bin"
add_to_path "${HOME}/Library/Application Support/JetBrains/Toolbox/scripts"
add_to_path "/opt/homebrew/bin"
add_to_path "/usr/local/opt/curl/bin"
add_to_path "${HOME}/.local/bin"
add_to_path "/opt/homebrew/opt/postgresql@16/bin"
add_to_path "${HOME}/.toolbox/bin"
add_to_path "${HOME}/.rvm/bin"
add_to_path "${HOME}/.cargo/bin"
add_to_path "/usr/local/aws-cli/v2/current/bin"
add_to_path "${HOME}/apache-maven-3.9.6/bin"

# Python path handling
if [[ -s "/opt/homebrew/opt/python@3.12/bin" ]]; then
    add_to_path "/opt/homebrew/opt/python@3.12/bin"
elif [[ -s "/opt/python3/bin/python3" ]]; then
    add_to_path "/opt/python3/bin"
fi

# Source configuration files
source_if_exists "${HOME}/.zprezto/runcoms/amazonrc"
source_if_exists "${HOME}/.fzf.zsh"
source_if_exists "${HOME}/.zprezto/fzf-git.sh"
source_if_exists "${HOME}/.iterm2_shell_integration.zsh"

export ZSH_TMUX_AUTOSTART=false
export ZSH_TMUX_AUTOSTART_ONCE=true
export ZSH_TMUX_AUTONAME_SESSION=true
export ZSH_TMUX_ITERM2=true
export ZSH_TMUX_UNICODE=true
export ZSH_TMUX_DETACHED=true

# If you come from bash you might have to change your $PATH.
# export PATH=$HOME/bin:$HOME/.local/bin:/usr/local/bin:$PATH

# Path to your Oh My Zsh installation.
export ZSH="$HOME/.oh-my-zsh"

# Set name of the theme to load --- if set to "random", it will
# load a random theme each time Oh My Zsh is loaded, in which case,
# to know which specific one was loaded, run: echo $RANDOM_THEME
# See https://github.com/ohmyzsh/ohmyzsh/wiki/Themes
# ZSH_THEME="headline"
ZSH_THEME="powerlevel10k/powerlevel10k"

# Set list of themes to pick from when loading at random
# Setting this variable when ZSH_THEME=random will cause zsh to load
# a theme from this variable instead of looking in $ZSH/themes/
# If set to an empty array, this variable will have no effect.
# ZSH_THEME_RANDOM_CANDIDATES=( "robbyrussell" "agnoster" )

# Uncomment the following line to use case-sensitive completion.
# CASE_SENSITIVE="true"

# Uncomment the following line to use hyphen-insensitive completion.
# Case-sensitive completion must be off. _ and - will be interchangeable.
# HYPHEN_INSENSITIVE="true"

# Uncomment one of the following lines to change the auto-update behavior
# zstyle ':omz:update' mode disabled  # disable automatic updates
# zstyle ':omz:update' mode auto      # update automatically without asking
# zstyle ':omz:update' mode reminder  # just remind me to update when it's time

# Uncomment the following line to change how often to auto-update (in days).
# zstyle ':omz:update' frequency 13

# Uncomment the following line if pasting URLs and other text is messed up.
# DISABLE_MAGIC_FUNCTIONS="true"

# Uncomment the following line to disable colors in ls.
# DISABLE_LS_COLORS="true"

# Uncomment the following line to disable auto-setting terminal title.
# DISABLE_AUTO_TITLE="true"

# Uncomment the following line to enable command auto-correction.
# ENABLE_CORRECTION="true"

# Uncomment the following line to display red dots whilst waiting for completion.
# You can also set it to another string to have that shown instead of the default red dots.
# e.g. COMPLETION_WAITING_DOTS="%F{yellow}waiting...%f"
# Caution: this setting can cause issues with multiline prompts in zsh < 5.7.1 (see #5765)
# COMPLETION_WAITING_DOTS="true"

# Uncomment the following line if you want to disable marking untracked files
# under VCS as dirty. This makes repository status check for large repositories
# much, much faster.
# DISABLE_UNTRACKED_FILES_DIRTY="true"

# Uncomment the following line if you want to change the command execution time
# stamp shown in the history command output.
# You can set one of the optional three formats:
# "mm/dd/yyyy"|"dd.mm.yyyy"|"yyyy-mm-dd"
# or set a custom format using the strftime function format specifications,
# see 'man strftime' for details.
# HIST_STAMPS="mm/dd/yyyy"

# Would you like to use another custom folder than $ZSH/custom?
ZSH_CUSTOM="${HOME}/.zprezto/oh-my-zsh/custom"

# Which plugins would you like to load?
# Standard plugins can be found in $ZSH/plugins/
# Custom plugins may be added to $ZSH_CUSTOM/plugins/
# Example format: plugins=(rails git textmate ruby lighthouse)
# Add wisely, as too many plugins slow down shell startup.
plugins=(
    git
    iterm2
    lol
    magic-enter
    man
    pip
    pylint
    python
    ssh
    # timer
    # tmux
    vscode
    zoxide
    zsh-autosuggestions
    zsh-interactive-cd
    zsh-syntax-highlighting
)

source "${ZSH}/oh-my-zsh.sh"

# User configuration

# export MANPATH="/usr/local/man:$MANPATH"

# You may need to manually set your language environment
# export LANG=en_US.UTF-8

# Preferred editor for local and remote sessions
# if [[ -n $SSH_CONNECTION ]]; then
#   export EDITOR='vim'
# else
#   export EDITOR='nvim'
# fi

# Compilation flags
# export ARCHFLAGS="-arch $(uname -m)"

# Set personal aliases, overriding those provided by Oh My Zsh libs,
# plugins, and themes. Aliases can be placed here, though Oh My Zsh
# users are encouraged to define aliases within a top-level file in
# the $ZSH_CUSTOM folder, with .zsh extension. Examples:
# - $ZSH_CUSTOM/aliases.zsh
# - $ZSH_CUSTOM/macos.zsh
# For a full list of active aliases, run `alias`.
#
# Example aliases
# alias zshconfig="mate ~/.zshrc"
# alias ohmyzsh="mate ~/.oh-my-zsh"

export ZPREZTO_HOME="${HOME}/.zprezto"

export EDITOR=nvim
export VISUAL=nvim


# if type starship > /dev/null; then
#     eval "$(starship init zsh)"
# fi

# Find latest java version
if [[ -z $JAVA_HOME ]]; then
    export JAVA_HOME="$(find "${HOME}/Library/Java/JavaVirtualMachines/" -type d -depth 1 |
        awk -F- '/[0-9]+\.[0-9]+\.[0-9]+/ {
            version=$NF;
            gsub(/\.jdk$/, "", version);
            split(version, v, ".");
            printf "%d %d %d %s\n", v[1], v[2], v[3], $0
        }' | sort -k1,1nr -k2,2nr -k3,3nr \
        | awk '{ print $4 "/Contents/Home" }' |
        head -n 1)"

    if [[ -s "${JAVA_HOME}" ]]; then
        export PATH="${JAVA_HOME}/bin:${PATH}"
        export JAVACMD="${JAVA_HOME}/bin/java"
    else
        RED='\033[31m'
        RED_ITALIC='\033[31;3m'
        RESET='\033[0m'
        echo "${RED}Auto detected JAVA_HOME '${RED_ITALIC}${JAVA_HOME}${RED}' does not actually exist, unsetting JAVA_HOME${RESET}"
        unset JAVA_HOME
    fi
fi

# OS defaults
alias "grep"="grep --color=auto"
alias "ll"="/bin/ls -Alh --color=auto"
alias "echo"="echo -e"
alias "beep"="echo -ne '\\007'"

# Misc
alias "java-version"="source ${HOME}/code/bin/java-version.sh"
alias "start-postgres"='LC_ALL="C" /opt/homebrew/opt/postgresql@16/bin/postgres -D /opt/homebrew/var/postgresql@16'
alias "rails"='gem exec rails'
alias "python"="python3"
alias "kill-grep"="ps -aux | grep -i "

# MacOS start steam using game toolkit (Apples fork of wine)
alias "win-steam"="gameportingtoolkit ${HOME}/steam-wine 'C:\\Program Files (x86)\\Steam\\steam.exe'"

# Kubernetes
alias "k"="kubectl"
alias "kgp"="kubectl get pods"
alias "kpf"="kubectl port-forward"
alias "kl"="kubectl logs"

# Easy stop logictech process when mx devices stop working
alias "kill-logi"="ps -A | grep -i 'Logitech' | grep -v 'grep' | awk '{ print \$1 }' | sudo xargs kill -9"

# Git stuff
alias "gg"="git graph"
alias "gr"="git -c color.ui=always graph | head -n \$((LINES * 60 / 100))"

function kill-all () {
    search_pattern="($(printf "%s|" "$@" | sed 's/|$//'))"
    ps -aux | grep -v grep | grep -iE "${search_pattern}" | awk '{ print $2 }' | xargs kill -9
}

alias "fix-iphone-mirroring"="rm /Users/smbayer/Library/Containers/com.apple.ScreenContinuity/Data/Library/Preferences/com.apple.ScreenContinuity.plist"

function tmux-tail () {
    # Check if at least one argument (session name) is provided
    if [[ $# -lt 1 ]]; then
        echo "Usage: tmux_logs <session_name> [number_of_lines]"
        return 1
    fi

    # Assign arguments to variables
    session_name=$1
    num_lines=${2:-100}  # Default to 100 if not provided

    # Check if the session exists
    if ! tmux has-session -t "$session_name" 2>/dev/null; then
        echo "Error: Tmux session '$session_name' not found"
        return 1
    fi

    # Capture and print the logs
    tmux capture-pane -p -t "$session_name" -S -"$num_lines" | grep -v '^$'
}

# Docker
alias "dc"="docker-compose"
alias "rm-images"="docker images | awk 'NR!=1' | awk '{ print \$3 }' | xargs docker image rm"

if [[ -s "/usr/local/aws-cli/v2/current/bin" ]]; then
    autoload bashcompinit && bashcompinit
    autoload -Uz compinit && compinit
    complete -C '/usr/local/aws-cli/v2/current/bin' aws
elif [[ -s "/usr/local/aws-cli" ]]; then
    autoload bashcompinit && bashcompinit
    autoload -Uz compinit && compinit
    complete -C '/usr/local/aws-cli/bin' aws
fi

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# Execute code that does not affect the current session in the background.
{
  # Compile the completion dump to increase startup speed.
  zcompdump="${ZDOTDIR:-${HOME}}/.zcompdump"
  if [[ -s "${zcompdump}" && (! -s "${zcompdump}.zwc" || "${zcompdump}" -nt "${zcompdump}.zwc") ]]; then
    zcompile "${zcompdump}"
  fi
} &!

# Print a random, hopefully interesting, adage.
if (( $+commands[fortune] )); then
  if [[ -t 0 || -t 1 ]]; then
    fortune -s
  fi
fi

# Source RVM if it exists
# source_if_exists "${HOME}/.rvm/scripts/rvm"

# ---- zoxide -----
eval "$(zoxide init zsh)"
alias cd='z'
alias cdi='zi'

# ---- FZF -----

# --- setup fzf theme ---
export FZF_DEFAULT_OPTS=$FZF_DEFAULT_OPTS'
    --color=fg:#9399b2,bg:-1,hl:#cdd6f4
    --color=fg+:#a6adc8,bg+:#313244,hl+:#7db6ff
    --color=info:#6c7086,prompt:#f38ba8,pointer:#cba6f7
    --color=marker:#79e5d5,spinner:#cdd6f4,header:#a6e3a1
    --color=label:#a6e3a1'

# -- Use fd instead of fzf --
export FZF_DEFAULT_COMMAND="fd --hidden --strip-cwd-prefix --exclude .git"
export FZF_CTRL_T_COMMAND="${FZF_DEFAULT_COMMAND}"
export FZF_ALT_C_COMMAND="fd --type=d --hidden --strip-cwd-prefix --exclude .git"

# Use fd (https://github.com/sharkdp/fd) for listing path candidates.
# - The first argument to the function ($1) is the base path to start traversal
# - See the source code (completion.{bash,zsh}) for the details.
function _fzf_compgen_path() {
  fd --hidden --exclude .git . "${1}"
}

# Use fd to generate the list for directory completion
function _fzf_compgen_dir() {
  fd --type=d --hidden --exclude .git . "${1}"
}

export FZF_CTRL_T_OPTS="--preview 'bat -n --color=always --line-range :500 {}'"
export FZF_ALT_C_OPTS="--preview 'eza --tree --color=always {} | head -200'"

# Advanced customization of fzf options via _fzf_comprun function
# - The first argument to the function is the name of the command.
# - You should make sure to pass the rest of the arguments to fzf.
function _fzf_comprun() {
  local command="${1}"
  shift

  case "${command}" in
    cd)           fzf --preview 'eza --tree --color=always {} | head -200' "$@" ;;
    export|unset) fzf --preview "eval 'echo \$'{}"         "$@" ;;
    ssh)          fzf --preview 'dig {}'                   "$@" ;;
    *)            fzf --preview "bat -n --color=always --line-range :500 {}" "$@" ;;
  esac
}

function fzf-keybinds() {
    echo "Files                         <󰘴> g <󰘴> F"
    echo "Branches                      <󰘴> g <󰘴> B"
    echo "Tags                          <󰘴> g <󰘴> T"
    echo "Remotes                       <󰘴> g <󰘴> R"
    echo "commit Hashes                 <󰘴> g <󰘴> H"
    echo "Stashes                       <󰘴> g <󰘴> S"
    echo "reflogs                       <󰘴> g <󰘴> L"
    echo "Worktrees                     <󰘴> g <󰘴> W"
    echo "Each ref (git for-each-ref)   <󰘴> g <󰘴> E"
}

function _fzf_git_fzf() {
    fzf --height "-3" \
        --tmux 90%,70% \
        --layout reverse \
        --multi \
        --min-height 20+ \
        --margin "2,4" \
        --border \
        --no-separator \
        --header-border horizontal \
        --border-label-pos 2 \
        --color 'label:#cdd6f4' \
        --preview-window 'right,70%' \
        --preview-border line \
        --bind 'ctrl-/:change-preview-window(down,50%|hidden|)' \
        "$@"
}

# ----- Bat (better cat) -----

if type "bat" > /dev/null; then
    alias cat="bat -P"
fi

# ---- Eza (better ls) -----

# --color-scale, --colour-scale
#   highlight levels of field distinctly.  Use comma(,) separated list of all, age, size
eza_cmd="eza --color=auto --long --git --icons=always --group-directories-first"
alias ll="${eza_cmd} --color-scale-mode=fixed --time-style=relative --group-directories-first"
alias la="${eza_cmd} --color-scale-mode=fixed --time-style=relative --group-directories-first --all"
alias lt="${eza_cmd} --color-scale-mode=gradient --color-scale=age --no-time --tree --level 2"

# ---- Jump -----

[[ -s "${HOME}/.autojump/etc/profile.d/autojump.sh" ]] && source "${HOME}/.autojump/etc/profile.d/autojump.sh"
autoload -U compinit && compinit -u

# ---- atuin -----

# ---- atuin (command history) -----
if type "atuin" > /dev/null
then
    eval "$(atuin init zsh)"
    # eval "$(atuin init zsh --disable-up-arrow)"
    eval "$(atuin gen-completions --shell zsh)"
fi

test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"

# ---- pipx autocomplete -----
# Maybe delete for Q?
if type "pipx" > /dev/null && type "register-python-argcomplete" > /dev/null
then
    autoload -U compinit && compinit
    # I might not need this:
    # autoload -U bashcompinit
    # bashcompinit
    eval "$(register-python-argcomplete pipx)"
fi

if [ -d "$HOME/.pyenv" ]
then
    export PYENV_ROOT="$HOME/.pyenv"
    [[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init -)"
fi

function colorize() {
    local message="$1"
    local match_text="$2"
    local color="$3"
    local reset=$'\e[0m'

    # Escape special characters in match_text for sed
    local escaped_match=$(echo "$match_text" | sed 's/[\/&]/\\&/g')

    # Use printf to properly interpret escape sequences
    # The $'...' syntax in zsh allows for interpretation of escape sequences
    printf "%b" "$(echo "$message" | sed -E "s/$escaped_match/$color&$reset/gI")"
}

function colorize_regex() {
    local message="$1"
    local pattern="$2"
    local color="$3"
    local reset=$'\e[0m'

    # Use printf to properly interpret escape sequences
    # The -E flag enables extended regular expressions
    printf "%b" "$(echo "$message" | sed -E "s/($pattern)/$color\\1$reset/g")"
}

function nvm-init() {
    export NVM_DIR="$HOME/.nvm"
    [ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"  # This loads nvm
    # [ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && \. "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"  # This loads nvm bash_completion
}
# nvm-init

#source_if_exists "${HOME}/.zprezto/runcoms/zshasyncrc"

[[ "$TERM_PROGRAM" == "kiro" ]] && . "$(kiro --locate-shell-integration-path zsh)"

if [[ "${ZSH_DEBUG}" == "true" ]]; then
    zprof
fi

